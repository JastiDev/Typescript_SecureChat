<!DOCTYPE html> <html lang="en"> <head> <meta charset="UTF-8"> <meta name="viewport" content="width=device-width, initial-scale=1"> <title>Secure Chat</title> <style>body{ margin:0;background-color:darkslategrey;}.app-container{ height:100vh;}.centering{ height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;}.dont-break-out{ width:300px;margin:20px;border:8px double grey; overflow-wrap:break-word;word-wrap:break-word;-ms-word-break:break-all; word-break:break-all; word-break:break-word; -ms-hyphens:auto;-moz-hyphens:auto;-webkit-hyphens:auto;hyphens:auto;}.overlaying{ position:fixed;top:0;left:0;width:100%;height:100%;background-color:darkslategrey;z-index:1000;display:none;}.chat-list{ flex:1;margin:30px;border:8px double grey;background-color:white;overflow:auto;} input[type=text], input[type=password]{ width:100%;padding:12px 20px;margin:8px 0;display:inline-block;border:1px solid #ccc;box-sizing:border-box;} button{ background-color:#4CAF50;color:black;font-size:large;width:200px;padding:14px 20px;margin:20px;border:none;cursor:pointer;}button:hover{ opacity:0.8;}.chat-send-btn{ background-color:black;color:white;width:fit-content;margin:5px;padding:10px;cursor:pointer;font-size:medium;}.chat-send-btn:hover{ opacity:0.8;} .cancelbtn{ width:auto;padding:10px 18px;background-color:#f44336;} .imgcontainer{ text-align:center;margin:24px 0 12px 0;position:relative;}img.avatar{ width:40%;border-radius:50%;}.container{ padding:16px;}span.psw{ float:right;padding-top:16px;} .modal{ display:none; position:fixed; z-index:1; left:0;top:0;width:100%; height:100%; overflow:auto; background-color:rgb(0,0,0); background-color:rgba(0,0,0,0.4); padding-top:60px;} .modal-content{ background-color:#fefefe;margin:5% auto 15% auto; border:1px solid #888;width:80%; } .close{ position:absolute;right:25px;top:0;color:#000;font-size:35px;font-weight:bold;}.close:hover, .close:focus{ color:red;cursor:pointer;} .animate{ -webkit-animation:animatezoom 0.6s;animation:animatezoom 0.6s }@-webkit-keyframes animatezoom{ from{-webkit-transform:scale(0)}to{-webkit-transform:scale(1)}}@keyframes animatezoom{ from{transform:scale(0)}to{transform:scale(1)}} @media screen and (max-width:300px){ span.psw{ display:block;float:none;}.cancelbtn{ width:100%;}}</style> <script src="https://cdnjs.cloudflare.com/ajax/libs/jsencrypt/2.3.1/jsencrypt.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.1.0/mqtt.min.js"></script> <script>document.addEventListener("DOMContentLoaded",function(e){var t=document.getElementById("chat-input");t.addEventListener("keydown",function(e){if(13===e.keyCode){var a=t.value;sendMsg(a),t.value=""}}),document.getElementById("chat-send").addEventListener("click",function(e){var a=t.value;sendMsg(a),t.value=""}),initAppData()});var STATUS_FIRST=0,STATUS_CREATE=1,STATUS_JOIN=2,STATUS_CHAT=3,data={sender:"A",roomId:"",apubkey:"",aprikey:"",bpubkey:"",bprikey:"",strCreate:""},appStatus,arrChat=[],initAppData=function(){chatService.leaveRoom(data.roomId),appStatus=STATUS_FIRST,arrChat=[],data={sender:"A",roomId:"",apubkey:"",aprikey:"",bpubkey:"",bprikey:"",strCreate:""}},handleCreate=function(){var e=cryptoService.generateKeyPair(),t=e.pubkey,a=e.prikey,n=chatService.generateRoomId().roomId;data.roomId=n,data.sender="A",data.apubkey=t,data.aprikey=a,data.strCreate=JSON.stringify({roomId:n,pubkey:t}),appStatus=STATUS_CREATE,chatService.enterRoom(data.roomId,onReceiveMsg),showIt("create-modal"),document.getElementById("strCreate").innerHTML=data.strCreate},showIt=function(e){document.getElementById(e).style.display="block"},hideIt=function(e){document.getElementById(e).style.display="none"},handleCopy=function(){navigator.clipboard.writeText(data.strCreate)},handleCreateCancel=function(){hideIt("create-modal"),initAppData()},handleJoin=function(){appStatus=STATUS_JOIN,showIt("join-modal")},handleJoinConfirm=function(){var e=document.getElementById("paste-panel").value;if(""!==(e=e.trim())){data.strCreate=e;var t=JSON.parse(e),a=cryptoService.generateKeyPair();data.sender="B",data.roomId=t.roomId,data.apubkey=t.pubkey,data.bpubkey=a.pubkey,data.bprikey=a.prikey,chatService.enterRoom(data.roomId,onReceiveMsg),chatService.sendMsg(data.roomId,{sender:data.sender,msgContent:data.bpubkey})}},handleJoinCancel=function(){hideIt("join-modal"),document.getElementById("paste-panel").value="",initAppData()},onReceiveMsg=function(e){if("A"===data.sender&&"B"===e.sender)if(data.bpubkey){var t=cryptoService.decrypt(e.msgContent,data.aprikey);if(!t)return;addToChatList({sender:e.sender,plain:t})}else data.bpubkey=e.msgContent,console.log("A received bpubkey from B: ",data.bpubkey),sendMsg("Hello"),startChat();else if("B"===data.sender&&"A"===e.sender){var t=cryptoService.decrypt(e.msgContent,data.bprikey);if(!t)return;0===arrChat.length&&(document.getElementById("paste-panel").value="",startChat()),addToChatList({sender:e.sender,plain:t})}},startChat=function(){appStatus=STATUS_CHAT,hideIt("create-modal"),hideIt("join-modal"),showIt("chat-page"),document.getElementById("chat-input").focus()},endChat=function(){hideIt("chat-page"),document.getElementById("chat-list").innerHTML="",initAppData()},addToChatList=function(e){if(""!==e.plain.trim()){arrChat.push(e);var t=document.getElementById("chat-list"),a=document.createElement("DIV"),n=document.createTextNode(e.sender+": "+e.plain);a.appendChild(n),t.appendChild(a)}},sendMsg=function(e){addToChatList({sender:data.sender,plain:e});var t="A"===data.sender?data.bpubkey:data.apubkey,a=cryptoService.encrypt(e,t);chatService.sendMsg(data.roomId,{sender:data.sender,msgContent:a})},cryptoService;!function(e){function t(){return r=new JSEncrypt({default_key_size:1024}),r.getKey(),{prikey:r.getPrivateKey(),pubkey:r.getPublicKey()}}function a(e,t){return e.length>117&&(e=e.substr(0,117)),r.setPublicKey(t),r.encrypt(e)}function n(e,t){r.setPrivateKey(t);var a=r.decrypt(e);return null===a?(console.log("Decrypt failed"),null):a}var r=null;e.generateKeyPair=t,e.encrypt=a,e.decrypt=n}(cryptoService||(cryptoService={}));var chatService;!function(e){function t(){return{roomId:""+Math.round(1e5*(Math.random()+1))}}function a(e,t){o.on("message",function(e,a){var n=JSON.parse(a.toString());t(n)}),o.subscribe(e),console.log(e)}function n(e,t){o.publish(e,JSON.stringify(t))}function r(e){o.unsubscribe(e),o=null,o=mqtt.connect("mqtts://test.mosquitto.org:8081",d)}var d={protocol:"wss"},o=mqtt.connect("wss://test.mosquitto.org:8081",d);e.generateRoomId=t,e.enterRoom=a,e.sendMsg=n,e.leaveRoom=r}(chatService||(chatService={}));</script> </head> <body> <div class="app-container"> <div id="first-page" class="centering"> <h1 class="animate">SECURE CHAT</h1> <button class="animate" onclick="handleCreate();"> CREATE </button> <button class="animate" onclick="handleJoin()"> JOIN </button> </div> <div id="create-modal" class="modal"> <div class="modal-content animate"> <div class="imgcontainer"> <span onclick="handleCreateCancel()" class="close" title="Close Modal">&times;</span> </div> <div class="container centering"> <div id="strCreate" class="dont-break-out"> </div> <strong>Please wait until your friend comes in.</strong> <button onclick="handleCopy()"> Copy </button> </div> </div> </div> <div id="join-modal" class="modal"> <div class="modal-content animate"> <div class="imgcontainer"> <span onclick="handleJoinCancel()" class="close" title="Close Modal">&times;</span> </div> <div class="container centering"> <textarea id="paste-panel" style="margin:20px" cols="30" rows="15" placeholder="Paste in the invite code from your friend."></textarea> <button onclick="handleJoinConfirm()"> JOIN </button> </div> </div> </div> <div id="chat-page" class="overlaying"> <div style="display:flex;height:100%;flex-direction:column;"> <span onclick="endChat()" class="close" title="Close">&times;</span> <div id="chat-list" class="chat-list"> </div> <div style="display:flex;margin:30px;"> <input id="chat-input" style="flex:1"> <button id="chat-send" class="chat-send-btn">SEND</button> </div> </div> </div> </div> </body> </html> 